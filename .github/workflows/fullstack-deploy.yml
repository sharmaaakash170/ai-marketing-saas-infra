name: Deploy FullStack

on: 
  push: 
    branches: [ main ]
env: 
  ENVIRONMENT: dev
    
jobs:
  # frontend: 
  #   name: Deploy frontend
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Setup Node
  #       uses: actions/setup-node@v4 
  #       with:
  #         node-version: 20 
      
  #     - run: |
  #         cd frontend
  #         npm install 
  #         npm run build

  #     - uses: aws-actions/configure-aws-credentials@v4
  #       with: 
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: us-east-1

  #     - run: |
  #         aws s3 sync frontend/build s3://${{ secrets.FRONTEND_BUCKET }} --delete
  #         aws cloudfront create-invalidation --distribution-id ${{ secrets.CF_DISTRIBUTION_ID }} --path "/*"

  #     # - name: Capture frontend deployment error
  #     #   id: deploy
  #     #   run: |
  #     #     set -o pipefail
  #     #     ./deploy.sh 2>&1 | tee deploy.log
        
  #     - name: Slack notification for successful deployment 
  #       if: success()
  #       run: |
  #         curl -X POST -H 'Content-type: application/json' \
  #         --data "{
  #           \"text\": \"‚úÖ *Deployment Successful* üöÄ\n\
  #           *App:* Frontend\n\
  #           *Environment:* $ENVIRONMENT\n\
  #           *Branch:* ${{ github.ref_name }}\n\
  #           *Triggered by:* ${{ github.actor }}\n\
  #           *Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n\
  #           <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>\"
  #         }" \
  #         ${{ secrets.SLACK_WEBHOOK_URL }}


  #     - name: Slack notification for faliure deployment 
  #       if: failure()
  #       run: |
  #         curl -X POST -H 'Content-type: application/json' \
  #         --data "{
  #           \"text\": \"‚ùå *Deployment Failed* üö®\n\
  #           *App:* Frontend\n\
  #           *Environment:* $ENVIRONMENT\n\
  #           *Branch:* ${{ github.ref_name }}\n\
  #           *Triggered by:* ${{ github.actor }}\n\
  #           *Job:* ${{ github.job }}\n\
  #           <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here to view failure logs>\"
  #         }" \
  #         ${{ secrets.SLACK_WEBHOOK_URL }}
  
  backend: 
    name: Deploy Backend 
    runs-on: ubuntu-latest
    # needs: frontend
    steps:
      - uses: actions/checkout@v4 

      - name: Copy backend to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_IP }}
          username: ubuntu
          key: |
            ${{ secrets.EC2_SSH_KEY }}
          source: "backend,docker-compose.yaml"
          target: "/home/ubuntu/app"

      # - name: SSH connectivity test
      #   uses: appleboy/ssh-action@v0.1.3
      #   with:
      #     host: ${{ secrets.EC2_IP }}
      #     username: ubuntu
      #     key: |
      #       ${{ secrets.EC2_SSH_KEY }}
      #     port: 22
      #     script: |
      #       whoami
      #       hostname


      - name: Deploy backend via SSH 
        uses: appleboy/ssh-action@v0.1.3
        with: 
          host: ${{ secrets.EC2_IP }}
          username: ubuntu
          key: |
            ${{ secrets.EC2_SSH_KEY }}
          port: 22
          debug: true
          use_insecure_cipher: true
          script: |
            cd /home/ubuntu/app/backend
            sudo docker compose down
            sudo docker compose up -d --build

      - name: Health check 
        run: |
          curl -f http://${{ secrets.EC2_IP }}/health || exit 1

      - name: Slack notification for successful deployment 
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"‚úÖ *Deployment Successful* üöÄ\n\
            *App:* Backend\n\
            *Environment:* $ENVIRONMENT\n\
            *Branch:* ${{ github.ref_name }}\n\
            *Triggered by:* ${{ github.actor }}\n\
            *Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n\
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}


      - name: Slack notification for faliure deployment 
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"‚ùå *Deployment Failed* üö®\n\
            *App:* Backend\n\
            *Environment:* $ENVIRONMENT\n\
            *Branch:* ${{ github.ref_name }}\n\
            *Triggered by:* ${{ github.actor }}\n\
            *Job:* ${{ github.job }}\n\
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here to view failure logs>\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
